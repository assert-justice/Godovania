extends KinematicBody2D

var random_floats = [0.7875557429979574, 0.06688220545526402, 0.9165877677951488, 0.8878262045516941, 0.0633065059174931, 0.1989169900164368, 0.7530013564203868, 0.9628884702788459, 0.6614768659396003, 0.36179169742026895, 0.544984561679846, 0.22039171938393187, 0.4967696697376578, 0.7460930395863957, 0.5306881119658429, 0.19373152697329976, 0.48593059572949593, 0.8385175393528159, 0.01937598457059797, 0.39356463182175505, 0.8641737618839069, 0.5809956685353518, 0.10338893873211774, 0.06226380755816874, 0.9432395863147177, 0.4119008046788024, 0.19869003590799372, 0.5337311803011449, 0.9463448849251808, 0.2638426485754194, 0.6938841158029176, 0.07714550386782759, 0.15754646349689216, 0.18071174032162107, 0.35385097779463526, 0.5632019694734178, 0.5487088777700729, 0.2088866184734942, 0.9796900084982058, 0.09413830093128095, 0.49484449151531773, 0.7038666435047839, 0.4749737001083493, 0.19430000866284358, 0.8905947858339953, 0.28686001652158566, 0.4037667306057817, 0.5001265572010641, 0.2333372217786408, 0.9074947950156731, 0.9528276395913567, 0.5641568201442969, 0.9274787668607378, 0.8076239791490818, 0.896366353662352, 0.11969291595464449, 0.4230217360008188, 0.06900379878318053, 0.524780574837119, 0.0576664752226943, 0.04142230116721113, 0.7767052429042353, 0.9099998219587704, 0.605692241531156, 0.9885775324331345, 0.663523434832717, 0.28994889494168274, 0.3707345911971004, 0.29126382549337115, 0.5588996119927756, 0.4433226606262708, 0.04780061423697457, 0.02879219239994979, 0.9437024876428207, 0.689853834427664, 0.8559909622776554, 0.0703161501749563, 0.32606185187818093, 0.488962325574519, 0.38582573938969145, 0.4886113056741076, 0.2338613992881401, 0.4768744381821973, 0.3244933024893848, 0.5731565666584848, 0.6500256690477508, 0.15749034468627454, 0.4702254790993342, 0.9645762383326691, 0.37824825018431263, 0.7646967239178595, 0.016252918923707615, 0.2612568037240428, 0.6258058976177734, 0.7424280444422278, 0.42484752055745845, 0.017133497046040058, 0.01771529143362549, 0.014037017283649589, 0.5489595136326045, 0.5696608506514166, 0.9049724242076255, 0.3203009022415808, 0.8035880464697004, 0.5459460999962024, 0.47220166224905846, 0.6966576414518604, 0.8311908256058567, 0.20525424182017915, 0.09730748585283899, 0.04941606962254763, 0.16851222223743112, 0.45759739833567314, 0.1187323408035712, 0.936211369570211, 0.11617540689782313, 0.5035334122135038, 0.5359875447904434, 0.3759099626614947, 0.9765927340659482, 0.7813828537996933, 0.7714086773836861, 0.6957461365573386, 0.15723296954561705, 0.6874402976560103, 0.16654023742568713, 0.5978131123541645, 0.5005467525044025, 0.9271811799431661, 0.7332722715155257, 0.1751850390511982, 0.01312653987433765, 0.3768392815344942, 0.2833796750962223, 0.09491829394880158, 0.1263153803997793, 0.44733596373030593, 0.18755702526775753, 0.28234554009095425, 0.5906880513063852, 0.05588477461977237, 0.019686847808847885, 0.5642711385794266, 0.5311631039395722, 0.12308419873133802, 0.4965734353400203, 0.12536934637499253, 0.18930440592704156, 0.4172573584075042, 0.45436187630305935, 0.12289421731342842, 0.6082216640796094, 0.8832919566579366, 0.02656677580869815, 0.7181969864267513, 0.8109029344514854, 0.9058346564486358, 0.2739643661780903, 0.8638000424291769, 0.6984787736003149, 0.49410656094860583, 0.9188877914235132, 0.060193374662789956, 0.3039978470532577, 0.8028830415959177, 0.09581997914971896, 0.8821233071376322, 0.17451552100916956, 0.9503517524489488, 0.036974434795130184, 0.9902122881257033, 0.1974052960772743, 0.32078319607227546, 0.4825507657109145, 0.5524724071908234, 0.9997494518831249, 0.43691954937832245, 0.0957538965207847, 0.08315332893724603, 0.7781623583203822, 0.7664469132698226, 0.4772041524328551, 0.43609881410001505, 0.3012539725639771, 0.967222602015096, 0.2073877903258584, 0.9475313169475296, 0.8051079344080315, 0.11200727555851953, 0.8312735956628914, 0.6034354938113603, 0.6002357237074339, 0.740259444454568, 0.2199419107091266, 0.0720310537744544, 0.4338678303859297, 0.05742920319797584, 0.016636034518168752, 0.26553536096429864, 0.7471085858737598, 0.9741930264734779, 0.5229237921029704, 0.5110106495733261, 0.4759026261047261, 0.3830391959563135, 0.04423628748860531, 0.770087959461948, 0.3490522104456958, 0.576139852791758, 0.5549873983044121, 0.9928809718406116, 0.5408376913159063, 0.3436521683244854, 0.7415789509739295, 0.1530664936554188, 0.5635967872076361, 0.8767582370762785, 0.8731853148350122, 0.3463936454069464, 0.8679548466874589, 0.7311828323946548, 0.5592735196770727, 0.10742476493650222, 0.10474732129047393, 0.7645354441671777, 0.9508160959647234, 0.14030408885548284, 0.6222137319444889, 0.19383443855200833, 0.6482145976721445, 0.07086825812775932, 0.8104957062047097, 0.5488607502694945, 0.8952075915088344, 0.19365504903888187, 0.6922210336323468, 0.5241468183496218, 0.9348805053624187, 0.11679554156890626, 0.4244069583296529, 0.619173133160334, 0.4905250321628911, 0.4342282652992999, 0.1615490654145465, 0.1272085667632169, 0.7445413626041139, 0.42734044469425747, 0.9797242893462415, 0.244046003673123, 0.3991261706665501, 0.5839507905104289, 0.9740010462124878, 0.281774290783542, 0.18888246753415106, 0.6555302544418746, 0.502583899829952]

var rand_index = 0

var velocity = Vector2()
var directions = [
	Vector2.LEFT,
	Vector2.RIGHT,
	Vector2.UP,
	Vector2.DOWN,
	Vector2(1,1).normalized(),
	Vector2(-1,1).normalized(),
	Vector2(1,-1).normalized(),
	Vector2(-1,-1).normalized(),
]

export var speed = 100
export var min_move_time = 20
export var max_move_time = 120
var move_timer = 0

export var shoot_cooldown = 120
export var burst_length = 3
export var burst_cooldown = 5
export var shot_speed = 500
export (PackedScene) var fireball_scene
var shoot_timer = 100
var burst = 0
var burst_timer = 0
var player
var space_state

export var health = 3
export var invuln_time = 20
var iframes = 0

var rng = RandomNumberGenerator.new()

signal damage(d)

func rand_vec():
	var angle = rng.randf() * 2 * PI
	var radius = rng.randf()
	var y = sin(angle) * radius
	var x = cos(angle) * radius
	return Vector2(x, y)

func _ready():
	space_state = get_world_2d().direct_space_state
	rand_index = int(floor(position.x + position.y)) % 256
	player = owner.get_node("Player")

func random():
	var val = random_floats[rand_index]
	if rand_index == len(random_floats) - 1:
		rand_index = 0
	else:
		rand_index += 1
	return val
	
func randint(minimum, maximum):
	return int(random() * (maximum - minimum) + minimum)

func is_near_wall():
	for d in directions:
		var probe = space_state.intersect_ray(position, position + d * speed / 3, [self])
		if len(probe) > 0:
			return true
	return false

func fire_control():
	if shoot_timer == 0:
		var probe = space_state.intersect_ray(position, player.position, [self])
		if probe.collider == player or position.distance_to(player.position) < 200:
			burst = burst_length
		shoot_timer = shoot_cooldown
	else:
		shoot_timer -= 1
	if burst > 0:
		if burst_timer == 0:
			burst -= 1
			var fireball = fireball_scene.instance()
			get_parent().add_child(fireball)
			fireball.position = position
			fireball.velocity = (player.position - position).normalized() * shot_speed
			burst_timer = burst_cooldown
		else:
			burst_timer -= 1

func pick_direction():
	var options = []
	for d in directions:
		var probe = space_state.intersect_ray(position, position + d * speed, [self])
		if len(probe) == 0:
			options.append(d)
	if len(options) == 0:
		options.append(Vector2())
	var dir = options[randint(0, len(options))]
	velocity = dir * speed

func _physics_process(delta):
	if health < 0:
		$AnimatedSprite.play("death")
		collision_layer = 0
	elif iframes > 0:
		iframes -= 1
		$AnimatedSprite.position = rand_vec() * 10
	else:
		space_state = get_world_2d().direct_space_state
		if move_timer < 0 or is_near_wall():
			pick_direction()
			move_timer = randint(min_move_time, max_move_time)
		else:
			move_timer -= 1
		$AnimatedSprite.set_flip_h(velocity.x > 0)
		velocity = move_and_slide(velocity)
		fire_control()

func _on_Squid_damage(d):
	health -= d
	iframes = invuln_time


func _on_AnimatedSprite_animation_finished():
	if $AnimatedSprite.animation == "death":
		queue_free()
